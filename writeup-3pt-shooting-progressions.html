<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>3pt Shooting Progressions</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="">
    <meta name="author" content="">

    <!-- Load d3.js -->
    <script src="https://d3js.org/d3.v4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/4.2.2/d3.min.js"></script>

    <!-- Le styles -->
    <link href="./assets/css/main.css" rel="stylesheet">
    <link href="./assets/css/bootstrap.css" rel="stylesheet">
    <link href="./assets/css/bootstrap-responsive.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.0.3/styles/default.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/gh/google/code-prettify@master/loader/run_prettify.js"></script>
        
    <style>

    /* GLOBAL STYLES
    -------------------------------------------------- */
    /* Padding below the footer and lighter body text */

    body {
      padding-bottom: 40px;
      color: #5a5a5a;
    }



    /* CUSTOMIZE THE NAVBAR
    -------------------------------------------------- */

    /* Special class on .container surrounding .navbar, used for positioning it into place. */
    .navbar-wrapper {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      z-index: 10;
      margin-top: 20px;
      margin-bottom: -90px; /* Negative margin to pull up carousel. 90px is roughly margins and height of navbar. */
    }
    .navbar-wrapper .navbar {

    }

    /* Remove border and change up box shadow for more contrast */
    .navbar .navbar-inner {
      border: 0;
      -webkit-box-shadow: 0 2px 10px rgba(0,0,0,.25);
         -moz-box-shadow: 0 2px 10px rgba(0,0,0,.25);
              box-shadow: 0 2px 10px rgba(0,0,0,.25);
    }

    /* Downsize the brand/project name a bit */
    .navbar .brand {
      padding: 14px 20px 16px; /* Increase vertical padding to match navbar links */
      font-size: 16px;
      font-weight: bold;
      text-shadow: 0 -1px 0 rgba(0,0,0,.5);
    }

    /* Navbar links: increase padding for taller navbar */
    .navbar .nav > li > a {
      padding: 15px 20px;
    }

    /* Offset the responsive button for proper vertical alignment */
    .navbar .btn-navbar {
      margin-top: 10px;
    }


    /* MARKETING CONTENT
    -------------------------------------------------- */

    /* Center align the text within the three columns below the carousel */
    .marketing .span4 {
      text-align: center;
    }
    .marketing h2 {
      font-weight: normal;
    }
    .marketing .span4 p {
      margin-left: 10px;
      margin-right: 10px;
    }


    /* Featurettes
    ------------------------- */

    .featurette-divider {
      margin: 80px 0; /* Space out the Bootstrap <hr> more */
    }
    .featurette {
      padding-top: 120px; /* Vertically center images part 1: add padding above and below text. */
      overflow: hidden; /* Vertically center images part 2: clear their floats. */
    }
    .featurette-image {
      margin-top: -120px; /* Vertically center images part 3: negative margin up the image the same amount of the padding to center it. */
    }

    /* Give some space on the sides of the floated elements so text doesn't run right into it. */
    .featurette-image.pull-left {
      margin-right: 40px;
    }
    .featurette-image.pull-right {
      margin-left: 40px;
    }

    /* Thin out the marketing headings */
    .featurette-heading {
      font-size: 50px;
      font-weight: 300;
      line-height: 1;
      letter-spacing: -1px;
    }



    /* RESPONSIVE CSS
    -------------------------------------------------- */

    @media (max-width: 979px) {

      .container.navbar-wrapper {
        margin-bottom: 0;
        width: auto;
      }
      .navbar-inner {
        border-radius: 0;
        margin: -20px 0;
      }

      .featurette {
        height: auto;
        padding: 0;
      }
      .featurette-image.pull-left,
      .featurette-image.pull-right {
        display: block;
        float: none;
        max-width: 40%;
        margin: 0 auto 20px;
      }
    }


    @media (max-width: 767px) {

      .navbar-inner {
        margin: -20px;
      }

      .marketing .span4 + .span4 {
        margin-top: 40px;
      }

      .featurette-heading {
        font-size: 30px;
      }
      .featurette .lead {
        font-size: 18px;
        line-height: 1.5;
      }

      /*.chart-title {
        font-family: sans-serif;
        font-size: 10pt;
      }*/

    }
    </style>

    <!-- HTML5 shim, for IE6-8 support of HTML5 elements -->
    <!--[if lt IE 9]>
      <script src="../assets/js/html5shiv.js"></script>
    <![endif]-->

    <!-- Fav and touch icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="./assets/ico/apple-touch-icon-144-precomposed.png">
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="./assets/ico/apple-touch-icon-114-precomposed.png">
      <link rel="apple-touch-icon-precomposed" sizes="72x72" href="./assets/ico/apple-touch-icon-72-precomposed.png">
                    <link rel="apple-touch-icon-precomposed" href="./assets/ico/apple-touch-icon-57-precomposed.png">
                                   <link rel="shortcut icon" href="./assets/ico/hatfield-dots-logo.png">
  </head>

  <body>

    <!-- NAVBAR
    ================================================== -->
    <div class="navbar-wrapper">
      <!-- Wrap the .navbar in .container to center it within the absolutely positioned parent. -->
      <div class="container">

        <div class="navbar navbar-inverse">
          <div class="navbar-inner">
            <!-- Responsive Navbar Part 1: Button for triggering responsive navbar (not covered in tutorial). Include responsive CSS to utilize. -->
            <button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
              <span class="icon-bar"></span>
            </button>
            <a class="brand" href="#">Michael Hatfield</a>
            <!-- Responsive Navbar Part 2: Place all navbar contents you want collapsed withing .navbar-collapse.collapse. -->
            <div class="nav-collapse collapse">
              <ul class="nav">
                <li class="active"><a href="#">Home</a></li>
                <li><a href="#about">About</a></li>
                <li><a href="#contact">Contact</a></li>
                <!-- Read about Bootstrap dropdowns at https://getbootstrap.com/2.3.2/javascript.html#dropdowns -->
                <li class="dropdown">
                  <a href="#" class="dropdown-toggle" data-toggle="dropdown">Dropdown <b class="caret"></b></a>
                  <ul class="dropdown-menu">
                    <li><a href="#">Action</a></li>
                    <li><a href="#">Another action</a></li>
                    <li><a href="#">Something else here</a></li>
                    <li class="divider"></li>
                    <li class="nav-header">Nav header</li>
                    <li><a href="#">Separated link</a></li>
                    <li><a href="#">One more separated link</a></li>
                  </ul>
                </li>
              </ul>
            </div><!--/.nav-collapse -->
          </div><!-- /.navbar-inner -->
        </div><!-- /.navbar -->
      </div> <!-- /.container -->
    </div><!-- /.navbar-wrapper -->

    <div class="container" style="padding-top: 6rem;">
      <div class="row">
        <p>
          Sixers season ended in a missed conference finals again, and I had myself wondering where they'd be next year. Could Matisse Thybulle ever become a true 3 and D player.
        </p>
      </div>
      <div class="row">
        <p>
          So why not get a view of the progression of every NBA players 3 pt shooting? The data we'd need is well organized for each player on basketball reference: https://www.basketball-reference.com/players/c/curryst01.html
        </p>
        <img src="./assets/img/fg3pt_shooting_progressions_basketball_reference_table.png">
        <p>
          Let's add some parameters to the data we'd like to gether from this site:
        </p>
        <ol>
          <li>Only players who have started playing in the NBA after 2000</li>
          <li>Only players who have played in the NBA beyond 2010</li>
        </ol>
      </div>
      <div class="row">
        <p>
          The python function below will return every player url, within the date bounds outlined, available from basketball-reference. <span class="collapsible">+ Expand Code</span>
        </p>
        <!--<button type="button" class="collapsible"> + Expand Code</button>-->
        <div class="content">
          <pre class="prettyprint lang-py"><code>start_year_min = 2000
end_year_min = 2010

def get_player_hrefs(base_url, alph):
    """ Returns a list of urls from the given basketball reference base url
        and the provide character, alph
    """
    
    ## Get the webpage contents
    r = requests.get(base_url + '/' + alph + '/', verify=False)
    soup = BeautifulSoup(r.text, 'html.parser')
    
    ## Extract the table rows containing player information
    data_rows = soup.find_all('tr')
    player_rows = [x for x in data_rows if 'data-stat="player"' in str(x)]
    
    player_href_links = [] ## The list to be returned
    for r in player_rows:
        cells_th = r.find_all('th')
        cells_td = r.find_all('td')

        ## Filter by start/end years
        start_year, end_year = None, None
        start_year_html = [x for x in cells_td if 'data-stat="year_min"' in str(x)]
        end_year_html = [x for x in cells_td if 'data-stat="year_max"' in str(x)]
        if (len(start_year_html)>0):
            start_year = start_year_html[0].contents[0]
        if (len(end_year_html)>0):
            end_year = end_year_html[0].contents[0]

        if start_year and end_year:
            if int(start_year) < start_year_min:
                continue
            if int(end_year) < end_year_min:
                continue

        ## try to get the href link
        player_link_results = cells_th[0].find_all('a', href=True)
        if len(player_link_results) > 0:
            player_href_links.append(player_link_results[0].get('href'))
            
    return player_href_links
          </code></pre>
        </div>
        <p>
          And this next python function will take a single player's url, and return a dictionary of th 3pt shooting statistics we care about. <span class="collapsible">+ Expand Code</span>
        </p>
        <!--<button type="button" class="collapsible"> + Expand Code</button>-->
        <div class="content">
          <pre class="prettyprint lang-py"><code>def get_3pt_shooting_data(player_url):
    """ Returns a dictionary of the player's 3pt shooting statistics
    """
    
    r = requests.get(player_url, verify=False)
    soup = BeautifulSoup(r.text, 'html.parser')
    
    ## Get the player name
    meta_section = soup.find_all('div', {'id': 'meta'})
    if len(meta_section) == 0:
        return
    player_name = meta_section[0].find_all('span')[0].contents[0]
    
    totals_table_list = soup.find_all('table', {'id': 'totals'})
    ## If empty, then return empty
    if len(totals_table_list) == 0:
        return
    
    ## Get the rows of the table
    totals_table = totals_table_list[0]
    rows = totals_table.find_all('tr')
    
    ## For each row, get the year, fg3, fg3a, and fg3_pct
    row_data = []
    for r in rows:
        tds = r.find_all('td')
        if (len(tds)==0):
            continue
            
        if (len([x for x in tds if 'data-stat="age"' in str(x)][0].contents)==0):
            continue
            
        age = [x for x in tds if 'data-stat="age"' in str(x)][0].contents[0]
        fg3 = [x for x in tds if 'data-stat="fg3"' in str(x)][0].contents[0]
        fg3a = [x for x in tds if 'data-stat="fg3a"' in str(x)][0].contents[0]
        if len([x for x in tds if 'data-stat="fg3_pct"' in str(x)][0].contents)==0:
            fg3_pct = '0'
        else:
            fg3_pct = [x for x in tds if 'data-stat="fg3_pct"' in str(x)][0].contents[0]
        row_dict = {'age': age, 'fg3': fg3, 'fg3a': fg3a, 'fg3_pct': fg3_pct}
        row_data.append(row_dict)
    
    return_data = {
        'name': player_name,
        'url': player_url,
        'row_data': row_data,
    }
    return return_data
          </code></pre>
        </div>
        <p>
          And lastly, our driver code to run both of the functions iteratively. After running this, the <code>all_player_data</code> variable will be a list of dictionaries of all the data we need. <span class="collapsible">+ Expand Code</span>
        </p>
        <!--<button type="button" class="collapsible"> + Expand Code</button>-->
        <div class="content">
          <pre class="prettyprint lang-py"><code>base_url = 'https://www.basketball-reference.com'
all_player_data = []
alphs = ['a','b','c','d','e','f','g','h','i','j','k','l','m','n','o','p','q','r','s','t','u','v','w','x','y','z']
for alph in alphs:
    
    player_href_links = get_player_hrefs('https://www.basketball-reference.com/players', alph)
    
    for player_url in player_href_links:
        print (alph, player_url)
        try:
            player_data = get_3pt_shooting_data(base_url + player_url)
            if ({'name','url','row_data'}==(set(player_data.keys()))):
                all_player_data.append(player_data)
        except Exception as e:
            print ('ERROR:', player_url)
            print (e)
          </code></pre>
        </div>
        <p>
          After checking to see the data was parsed correctly, we'll save it all to json file for easier access. <span class="collapsible">+ Expand Code</span>
        </p>
        <!--<button type="button" class="collapsible"> + Expand Code</button>-->
        <div class="content">
          <pre class="prettyprint lang-py"><code>## Need to go through and covnert bs4 type objects to strings
for x in all_player_data:
    x['name'] = str(x['name'])
    x['url'] = str(x['url'])
    for row in x['row_data']:
        row['age'] = str(row['age'])
        row['fg3'] = str(row['fg3'])
        row['fg3a'] = str(row['fg3a'])
        row['fg3_pct'] = str(row['fg3_pct'])

import json
with open('../Data/nba_3pt_progressions_all_players.json', 'w') as f:
    json.dump(all_player_data, f)
    f.close()
          </code></pre>
        </div>
      </div>
      <div class="row">
        <p>
          We'll load the data back into a pandas dataframe for ease of use, and while loading that, we'll also add in a filter to sort out seasons where a player didn't attempt enough 3 pointers to be worth analysiing (threshold set at 25 in this code block). This code also includes a check to account for instances where a player was traded in the middle of the season, as basketball-reference includes as "Total" row, and a row for each of the two teams, all for the same season. The only one needed for this analysis is the total row. <span class="collapsible">+ Expand Code</span>
        </p>
        <!--<button type="button" class="collapsible"> + Expand Code</button>-->
        <div class="content">
          <pre class="prettyprint lang-py"><code>## Read the data back in
file_3pt_shooting = '../Data/nba_3pt_progressions_all_players.json'
with open(file_3pt_shooting, 'r') as f:
    data_3pt_shooting = json.load(f)
    f.close()

## Need to create a dataframe with the following columns
##  name     - will be the 'units' value for sns.lineplot
##  season   - will be the x axis
##  fg3
##  fg3a
##  fg3_pct  - will be the y axis

records_3pt_shooting = []
for row in data_3pt_shooting:
    name = row['name']
    min_age = min([int(x['age']) for x in row['row_data']])
    prev_age = 0
    for season in row['row_data']:
        year = int(season['age']) - min_age
        fg3 = float(season['fg3'].replace('<strong>','').replace('</strong>',''))
        fg3a = float(season['fg3a'].replace('<strong>','').replace('</strong>',''))
        fg3_pct = float(season['fg3_pct'].replace('<strong>','').replace('</strong>',''))
        
        ## check for minimum attempts
        ##  and consolidate to only the "TOT" column if multiple teams in 1 seasons
        if fg3a > 25 and prev_age!=season['age']:
            records_3pt_shooting.append({
                'name': name,
                'year': year,
                'fg3': fg3,
                'fg3a': fg3a,
                'fg3_pct': fg3_pct,
            })
        prev_age = season['age']

df_3pt_shooting = pd.DataFrame(records_3pt_shooting)
          </code></pre>
        </div>
        <p>
          Let's plot the full dataset: <span class="collapsible">+ Expand Code</span>
        </p>
        <!--<button type="button" class="collapsible"> + Expand Code</button>-->
        <div class="content">
          <pre class="prettyprint lang-py"><code>import matplotlib.pyplot as plt
import seaborn as sns
sns.set(rc = {'figure.figsize':(15, 8)})
sns.lineplot(
    data=df_3pt_shooting,
    x="year", y="fg3_pct", units="name",
    estimator=None, lw=1, alpha=0.3
)
          </code></pre>
        </div>
        <img src="./assets/img/fg3pt_shooting_progressions_all_original.png">
      </div>
      <div class="row">
        <p>
          One caveat to add at this point is that the current visualization and dataset includes players with just 1 year, which are just non-visable dots on this chart. And you can also see that players might not have their first instance of 25+ 3pt field goal attempts in the first season, and may also skip seasons. For the players with just one year, we'll just remove those from the dataset so that those player names aren't unecessarily included down the line. As for the players whose progression plots start after that first year, we'll write a function to re-base those to be their first year, and will be able to toggle between both for plotting purposes.
        </p>
        <p>
          But first, let's build in some functionality so that we can view a specific player for (1) validating that this is working correctly, and (2) aiding some analysis later on. 
        </p>

        <!--<div id="interactive-3pt-plot"></div>-->
        <!-- Initialize an autofill dropdown -->
        <div class="chart-title" style="display: flex; justify-content: center;">NBA 3pt FG Percentage Progressions</div>
        <div style="display: flex; justify-content: center;">
          <input id="player-names-input" list="player-names" placeholder="Start typing..." style="width: 300px;">
          <datalist id="player-names"></datalist>
        </div>

        <!-- Create a div where the graph will take place -->
        <div id="my_dataviz"></div>

      </div>
      <div class="row">
        <p>
          Regarding the re-baseing of first years back to zero, in order to make it easy to flip between the two, we'll create a new column for "base zero year". So if a player's first year attempting >25 3pt fgs was their 3rd year, that will now be an x-axis value of 0. And if they recorded >25 3pt fgs in their 5th year (regardless of if they did in their 4th year), that will be an x-axis value of 2. <span class="collapsible">+ Expand Code</span>
        </p>
        <div class="content">
          <pre class="prettyprint lang-py"><code>## get the list of all name occurrences
all_name_occurrences = set(list(df_3pt_shooting['name']))

def calc_base_zero_year(df, player, current_season):
    
    ## Get the min season value
    min_season = min(list(df[df['name']==player]['year']))
    
    ## Return the difference
    return current_season - min_season

df_3pt_shooting['year_zero'] = df_3pt_shooting.apply(lambda x: calc_base_zero_year(df_3pt_shooting, x['name'], x['year']), axis=1)

def calc_zero_year_fg3_pct(df, player):
    
    ## Get the fg3_pct value for this player at year zero
    fg3_pct_zero = list(df[(df['name']==player)&(df['year_zero']==0)]['fg3_pct'])[0]
    
    return fg3_pct_zero

df_3pt_shooting['year_zero_fg3_pct'] = df_3pt_shooting.apply(lambda x: calc_zero_year_fg3_pct(df_3pt_shooting, x['name']), axis=1)

          </code></pre>
        </div>
      </div>
      <div id="main-regressiongroups" class="row">
        <p>
          So now that we have our data and visualization structured the way we want, with some added flexability, let's start looking at some simple regressions. To begin, we can just use the scikit-learn Linear Regression model. For each player, we can filter the full dataframe and run a linear regression of their 3pt fg percentage against years. <span class="collapsible">+ Expand Code</span>
        </p>
        <div class="content">
          <pre class="prettyprint lang-py"><code>def get_lin_reg_coef(df_3pt_shooting, player_name):
    """ Given the full dataframe, and a player's name, extract their 3pt fg pcts and years as lists, 
        and return the coefficients of a linear regression between the two as Y and X.
    """
    df_player = df_3pt_shooting[df_3pt_shooting['name']==player_name]
    
    X = df_player['year'].values.reshape(-1, 1)
    Y = df_player['fg3_pct'].values.reshape(-1, 1)
    linear_regressor = LinearRegression()  # create object for the class
    linear_regressor.fit(X, Y)  # perform linear regression
    
    return linear_regressor.coef_[0][0]
          </code></pre>
        </div>
        <p>
          We've got a list now containing each players name and their accompanying linear regression coefficinet. Let's use that to group the pool of players into those that (1) improved their 3 point shooting, (2) remained about the same, and (3) got worse. The resulting plot of that is below, where the improvement progressions are in green, constant in gray, and the declines in red. <span class="collapsible">+ Expand Code</span>  At these parameters, we end up with 180 players who improved their 3pt shooting over their career, 164 who got worse, and 404 who remained about the same throughout.
        </p>
        <div class="content">
          <pre class="prettyprint lang-py"><code>## Split Regressions into improvement, meh, and decline
bound_inc = 0.01  ## Equates to improving 1% per year
bound_dec = -0.01 ## Equates to worsening 1% per year
regression_improvement, regression_same, regression_decline = [], [], []
for x in regression_coefficients:
    if x[1] >= bound_inc:
        regression_improvement.append(x)
    elif x[1] >= bound_dec:
        regression_same.append(x)
    else:
        regression_decline.append(x)
        
print ('Improve  :', len(regression_improvement))
print ('Constant :', len(regression_same))
print ('Decline  :', len(regression_decline))

-----------------
Out: Improve: 180
     Same   : 404
     Decline: 164
          </code></pre>
        </div>
        <section id="intro"></section>
        <section id="scrolly-regressiongroups">
          <figure>
            <img id="scrolly-plot-reggroups" src="./assets/img/fg3pt_shooting_progressions_buckets.png">
            <p></p>
          </figure>
          <article>
            <div class="step" data-step="1">
              <p>Progressions by Groups</p>
              <div class="step-content">The resulting plot of that is here, where the improvement progressions are in green, constant in gray, and the delines in red. This plot partitions the groups based on the slope coefficient of a linear regression fit to the player's 3pt shooting dataset. Coefficients larger than +/- 1% get placed into the improvement and deline buckets respectively.</div>
            </div>
            <div class="step" data-step="2">
              <p>Kyle Lowry</p>
              <div class="step-content">This isn't a perfect view however, since a player in the league for 15 years would need to improve their 3pt shooting by 15% from start to finish⁠—which is never going to happen⁠—to be in the improve category. This plot shows Kyle Lowry's 3pt percentages, and we can clearly see a sustained level of improvement between his 4th and 5th seasons.</div>
            </div>
            <div class="step" data-step="3">
              <p>Carmelo Anthony</p>
              <div class="step-content">Carmelo Anthony is another player who gets grouped into the "constant" group. Over a longer career though, there'll be up swings and down swings in 3pt percentage shooting, which aren't going to be captured by a simple linear regression.</div>
            </div>
            <div class="step" data-step="4">
              <p>Dejounte Murray</p>
              <div class="step-content">This simple method fits well enough though for players with a shorter set of data points. Dejounte Murray only has 5 years of valid 3pt shooting data, which seems to fit the goal of identify if improvement is possible after a player's start, without factoring in external changes of a long career.</div>
            </div>
          </article>
        </section>
        <section id="outro"></section>
      </div>
      <div class="row">
        <p>
          Regressions aside, what if we wanted to figure out which players in this dataset have the most similar shooting progression to someone we're interested in project. This all started out with wondering what in the world Matisse Thybulle can bring to the table, so let's just go ahead and cut right to him.
        </p>
        <p>
          Over Matisse Thybulle's first 3 years, he's shot 35.7%, 30.1%, and 31.3% on 3pt FGs, with a career average of 32.4. And we'd like to find players with similar shooting in their first 3 years, and be able to understand how their 3pt shooting evolved over the rest of their career. We'll use two different metrics for assessing similarity of shooting datasets. The first, being the difference of career average 3pt fg percentage. The second the minimum total residual between datasets. <span class="collapsible">+ Expand Code</span>
        </p>
        <div class="content">
          <pre class="prettyprint lang-py"><code>## Compare two datasets - Mean Residuals
def get_area_between_curves(curve_1, curve_2):
    """ Each curve is a list of (x,y) coordinates
          and is sorted ascending by the x value
    """  
    
    area = 0
    i = 0
    j = 0
    while i < len(curve_1) and j < len(curve_2):
        if curve_1[i][0] > curve_2[j][0]:
            j += 1
        elif curve_1[i][0] > curve_2[j][0]:
            i +=1
        else:
            area += abs(curve_1[i][1] - curve_2[j][1])
            i += 1
            j += 1
            
    return area

## Compare two datasets - Average
def get_difference_btwn_avg_fgpct(df_1, df_2):
    """ Each dataframe has the shooting data
            fg3  : made 3pts
            fg3a : attempted 3pts
        Add up the data for each relevant year and compute career average
        Return the difference of players
    """
    
    fg_made_1 = list(df_1['fg3'])
    fg_attempted_1 = list(df_1['fg3a'])
    fg_made_2 = list(df_2['fg3'])
    fg_attempted_2 = list(df_2['fg3a'])
    
    career_avg_1 = sum(fg_made_1) / sum(fg_attempted_1)
    
    if len(fg_made_2) > len(fg_made_1):
        career_avg_2 = sum(fg_made_2[:len(fg_made_1)]) / sum(fg_attempted_2[:len(fg_attempted_1)])
        #print (fg_made_2[:len(fg_made_1)])
        #print (fg_made_1)
    else:
        career_avg_2 = sum(fg_made_2) / sum(fg_attempted_2)
    
    return abs(career_avg_2 - career_avg_1)
          </code></pre>
        </div>
        <p>
          We'll use those two function to create a metric of similarity for every other player with which we can compare to Matisse Thybulle's 3pt shooting. This code below gathers those two metrics for all other players and saves it as a tuple (player name, mean residuals of 3pt fg pct, difference in avg 3pt fg pct) in a list of all the players. It then plots the top 25 most similar players by both metrics. <span class="collapsible">+ Expand Code</span>
        </p>
        <div class="content">
          <pre class="prettyprint lang-py"><code>## Find the N most and least similar shooting progressions to a given player
n_comps = 25

# Set the player name
player_comp = 'Matisse Thybulle' #random.choice(list(all_name_occurrences))

# Get that player's data as a list of tuples
df_player = df_3pt_shooting[df_3pt_shooting['name']==player_comp]
player_curve = list(zip(list(df_player['year_zero']),list(df_player['fg3_pct'])))

print (player_comp)
print (player_curve)
similarity_scores = []

for pn in all_name_occurrences:
    if pn==player_comp:
        continue
    else:
        # Get test player's data as a list of tuples
        df_test = df_3pt_shooting[df_3pt_shooting['name']==pn]
        test_curve = list(zip(list(df_test['year_zero']),list(df_test['fg3_pct'])))
        
        # Only if test curve is longer than player curve
        #if len(test_curve) > len(player_curve):
        if len(test_curve) > (len(player_curve)+3):
            # Calculate area between datasets
            area_between = get_area_between_curves(player_curve, test_curve)
            
            # Calculate the difference in avg 3pt fg%
            avg_pct_diff = get_difference_btwn_avg_fgpct(df_player, df_test)
            
            # Add to records
            similarity_scores.append((pn, area_between, avg_pct_diff))

similarity_scores = sorted(similarity_scores, key=lambda x: x[1])
for i in range(n_comps):
    fig = sns.lineplot(
        data=df_3pt_shooting[df_3pt_shooting['name']==similarity_scores[i][0]],
        x='year_zero', y="fg3_pct", units="name",
        estimator=None, lw=1, alpha=0.5, color='blue'
    )
    
similarity_scores = sorted(similarity_scores, key=lambda x: x[2])
for i in range(n_comps):
    sns.lineplot(
        data=df_3pt_shooting[df_3pt_shooting['name']==similarity_scores[i][0]],
        x='year_zero', y="fg3_pct", units="name",
        estimator=None, lw=1, alpha=0.5, color='red'
    )
    
sns.lineplot(
    data=df_3pt_shooting[df_3pt_shooting['name']==player_comp],
    x='year_zero', y="fg3_pct", units="name",
    estimator=None, lw=3, alpha=1, color='black'
)
    
fig.set_ylim(0, 0.6)
          </code></pre>
        </div>
        <img id="scrolly-plot-reggroups" src="./assets/img/fg3pt_shooting_progressions_matisse_tybulle_similarity.png">
      </div>
      <div>
        <ol>
          <li>[x] Just re-organize this a bit. Reset every player to base year zero</li>
          <li>[x] Split into players with +/0/- linear regressions</li>
          <li>[x] ow many in each bucket?</li>
          <li>Given a player (Matisse), who are all the comparable players?</li>
          <li>players with average fg% within +/-x of first N seasons</li>
          <li>and what are the trends of those players?</li>
        </ol>
      </div>
   </div>

        <!-- javascript
    ================================================== -->
    <!-- Placed at the end of the document so the pages load faster -->
    <!--<script src="./assets/js/jquery.js"></script>-->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

    <!-- Scrollama Import -->
    <script src="https://unpkg.com/scrollama"></script>
    
    <script src="./assets/js/bootstrap-transition.js"></script>
    <script src="./assets/js/bootstrap-alert.js"></script>
    <script src="./assets/js/bootstrap-modal.js"></script>
    <script src="./assets/js/bootstrap-dropdown.js"></script>
    <script src="./assets/js/bootstrap-scrollspy.js"></script>
    <script src="./assets/js/bootstrap-tab.js"></script>
    <script src="./assets/js/bootstrap-tooltip.js"></script>
    <script src="./assets/js/bootstrap-popover.js"></script>
    <script src="./assets/js/bootstrap-button.js"></script>
    <script src="./assets/js/bootstrap-collapse.js"></script>
    <script src="./assets/js/bootstrap-carousel.js"></script>
    <script src="./assets/js/bootstrap-typeahead.js"></script>

    <!-- Load the interactive 3pt Progression Plot -->
    <!--<script> 
      $(function(){
        $("#interactive-3pt-plot").load("interactive-3pt-shooting-progressions.html"); 
      });
    </script> -->

    <script>
      var coll = document.getElementsByClassName("collapsible");
      var i;

      for (i = 0; i < coll.length; i++) {
        coll[i].addEventListener("click", function() {
          this.classList.toggle("active");
          //var content = this.nextElementSibling;
          var content = this.parentElement.nextElementSibling;
          if (content.style.display === "block") {
            this.innerHTML = ' + Expand Code';
            content.style.display = "none";
          } else {
            //this.innerHTML = ' — Collapse Code';
            this.innerHTML = ' − Collapse Code';
            content.style.display = "block";
          }
        });
      }
    </script>

    <!-- Color Scale -->
    <script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>

    <script>
      // set the dimensions and margins of the graph
      console.log("Screen Width: " + screen.width);

      //const full_width = 800;
      if (screen.width > 1170) {
        full_width = 1170;
      } else if (screen.width > 800) {
        full_width = 800;
      } else {
        full_width = screen.width;
      }
      //const full_height = 400;
      const full_height = full_width / 2;

      var margin = {top: 10, right: 30, bottom: 30, left: 60},
          width = full_width - margin.left - margin.right,
          height = full_height - margin.top - margin.bottom;

      // append the svg object to the body of the page
      var svg = d3.select("#my_dataviz")
        .append("svg")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
        .append("g")
          .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

      // create the background color for the chart
      /*svg.append("rect")
          .attr("width", "710")
          .attr("height", "360")
          .attr("fill", "#eaeaf2");*/
      svg.append("rect")
          .attr("width", width.toString())
          .attr("height", height.toString())
          .attr("fill", "#eaeaf2");

      //Read the data
      //d3.csv("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/5_OneCatSevNumOrdered.csv", function(data) {
      d3.csv("./assets/data/nba_3pt_progressions_dataframe.csv", function(data) {

          // List of groups (here I have one group per column)
          var allGroup = d3.map(data, function(d){return(d.name)}).keys()

          // Add those player names to the autofill dropdown
          var list_player_names = document.getElementById('player-names');
          allGroup.forEach(function(item){
              var option = document.createElement('option');
              option.value = item;
              list_player_names.appendChild(option);
          });

          // add the options to the button
          d3.select("#selectButton")
            .selectAll('myOptions')
            .data(allGroup)
            .enter()
            .append('option')
            .text(function (d) { return d; }) // text showed in the menu
            .attr("value", function (d) { return d; }) // corresponding value returned by the button

          // A color scale: one color for each group
          var myColor = d3.scaleOrdinal()
            .domain(allGroup)
            .range(d3.schemeSet2);

          // Add X axis --> it is a date format
          var x = d3.scaleLinear()
            .domain(d3.extent(data, function(d) { return parseInt(d.year); }))
            .range([ 0, width ]);
          svg.append("g")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x).ticks(7));

          svg.append("text")
            .attr("class", "x label")
            .attr("text-anchor", "end")
            .attr("x", margin.left + (width / 2))
            .attr("y", height + 30)
            .text("Years in the NBA")
            .style('font-family','sans-serif')
            .style('font-size','14px');

          // Add Y axis
          var y = d3.scaleLinear()
            .domain([0, d3.max(data, function(d) { return +d.fg3_pct; })])
            .range([ height, 0 ]);
          svg.append("g")
            .call(d3.axisLeft(y));

          svg.append("text")
            .attr("class", "y label")
            .attr("text-anchor", "end")
            .attr("y", -45)
            .attr("x", -(full_height / 4) + margin.bottom)
            .attr("dy", ".75em")
            .attr("transform", "rotate(-90)")
            .text("3pt FG Percentage")
            .style('font-family','sans-serif')
            .style('font-size','14px');;

          // Create a line for each name in the list
          for (var i=0; i < allGroup.length; i++) {
            //console.log(allGroup[i]);
            var line = svg
              .append('g')
                .append("path")
                  .datum(data.filter(function(d){return d.name==allGroup[i]}))
                  .attr("d", d3.line()
                    .x(function(d) { return x(d.year) })
                    .y(function(d) { return y(+d.fg3_pct) })
                  )
                  .attr("stroke", "rgb(76 114 176 / 30%)") //rgb(0,0,255, 0.3)
                  .style("stroke-width", 1)
                  .style("fill", "none")
          }

          // Initialize line with first group of the list
          var line = svg
            .append('g')
            .append("path")
              .datum(data.filter(function(d){return d.name==allGroup[0]}))
              .attr("d", d3.line()
                .x(function(d) { return x(d.year) })
                .y(function(d) { return y(+d.fg3_pct) })
              )
              .attr("stroke", "orange") //function(d){ return myColor("valueA") })
              .style("stroke-width", 4)
              .style("fill", "none")

          // A function that update the chart
          function update(selectedGroup) {

            // Create new data with the selection?
            var dataFilter = data.filter(function(d){return d.name==selectedGroup})

            // Give these new data to update line
            line
                .datum(dataFilter)
                .transition()
                .duration(1000)
                .attr("d", d3.line()
                  .x(function(d) { return x(d.year) })
                  .y(function(d) { return y(+d.fg3_pct) })
                )
                .attr("stroke", "orange") //function(d){ return myColor(selectedGroup) })
          }

          // When the button is changed, run the updateChart function
          d3.select("#player-names-input").on("change", function(d) {
              // recover the option that has been chosen
              var selectedOption = d3.select(this).property("value")
              // run the updateChart function with this selected option
              update(selectedOption)
          })

      })
    </script>

    <script>
      // using d3 for convenience
      var main = d3.select("#main-regressiongroups"); //var main = d3.select("main");
      var scrolly = main.select("#scrolly-regressiongroups");
      var figure = scrolly.select("figure");
      var article = scrolly.select("article");
      var step = article.selectAll(".step");

      // initialize the scrollama
      var scroller = scrollama();

      // generic window resize listener event
      function handleResize() {
        // 1. update height of step elements
        var stepH = Math.floor(window.innerHeight * 0.75);
        step.style("height", stepH + "px");

        //console.log(document.getElementById('scrolly-plot-reggroups').clientHeight);
        var figureHeight = Math.max(window.innerHeight / 2, document.getElementById('scrolly-plot-reggroups').clientHeight);
        //var figureHeight = window.innerHeight / 2;
        var figureMarginTop = (window.innerHeight - figureHeight) / 2;

        figure
          .style("height", figureHeight + "px")
          .style("top", figureMarginTop + "px");

        // 3. tell scrollama to update new element dimensions
        scroller.resize();
      }

      // scrollama event handlers
      function handleStepEnter(response) {
        // response = { element, direction, index }

        // add color to current step only
        step.classed("is-active", function (d, i) {
          return i === response.index;
        });

        // update graphic based on step
        //figure.select("p").text(response.index + 1);

        // update the scrolly chart regression group url
        //var plot = d3.select('#scrolly-plot-reggroups');
        if (response.index == 0) {
          //d3.select('#scrolly-plot-reggroups').src="./assets/img/fg3pt_shooting_progressions_buckets.png";
          $("#scrolly-plot-reggroups").attr("src", "./assets/img/fg3pt_shooting_progressions_buckets.png");
          //figure.select("p").text("The resulting plot of that is here, where the improvement progressions are in green, same in gray, and the delines in red.");
        } else if (response.index == 1) {
          //d3.select('#scrolly-plot-reggroups').src="./assets/img/fg3pt_shooting_progressions_buckets_kylelowry.png";
          $("#scrolly-plot-reggroups").attr("src", "./assets/img/fg3pt_shooting_progressions_buckets_kylelowry.png");
          //figure.select("p").text("This isn't a perfect view however, since a player in the league for 15 years would need to improve their 3pt shooting by 15% from start to finish, which is never going to happen, to be in the improve category. This plot shows Kyle Lowry's 3pt percentages, and we can clearly see a sustained level of improvement between his 4th and 5th seasons.");
        } else if (response.index == 2) {
          //d3.select('#scrolly-plot-reggroups').src="./assets/img/fg3pt_shooting_progressions_buckets_carmeloanthony.png";
          $("#scrolly-plot-reggroups").attr("src", "./assets/img/fg3pt_shooting_progressions_buckets_carmeloanthony.png");
          //figure.select("p").text("");
        } else if (response.index == 3) {
          //d3.select('#scrolly-plot-reggroups').src="./assets/img/fg3pt_shooting_progressions_buckets_dejountemurray.png";
          $("#scrolly-plot-reggroups").attr("src", "./assets/img/fg3pt_shooting_progressions_buckets_dejountemurray.png");
          //figure.select("p").text("");
        }
        //console.log(d3.select('#scrolly-plot-reggroups').src);
        //console.log(d3.select('#scrolly-plot-reggroups'));
        
      }


      function init() {

        // 1. force a resize on load to ensure proper dimensions are sent to scrollama
        handleResize();

        // 2. setup the scroller passing options
        //    this will also initialize trigger observations
        // 3. bind scrollama event handlers (this can be chained like below)
        scroller
          .setup({
            step: "#scrolly-regressiongroups article .step",
            offset: 0.33,
            debug: false
          })
          .onStepEnter(handleStepEnter);
      }

      // kick things off
      init();
    </script>

  </body>
</html>
